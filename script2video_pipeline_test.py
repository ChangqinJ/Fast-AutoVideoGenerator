from pipelines.script2video_pipeline import Script2VideoPipeline
from langchain.chat_models import init_chat_model
from tools.image_generator.doubao_seedream import DoubaoSeedreamImageGenerator
from tools.image_generator.gemini import GeminiImageGenerator
from tools.video_generator.veo import VeoVideoGenerator
from tools.video_generator.doubao_seedance import DoubaoSeedanceVideoGenerator
import asyncio
import logging

#相机速度变化:[0-2]45度/秒,[3-3.5]360度/秒,[3.5-5.5]45度/秒,[5.5-6]360度/秒,[6-8]45度/秒,[8-8.5]360度/秒,[8.5-10]45度/秒,强调:整个过程镜头速度变化应该是:慢-很快-慢-很快-慢-很快-慢-很快
script = \
"""
only 3 shot!only 3 shot! only 3 shot!!!
全局人物描述
林黛玉外形特征（贯穿全片）：

身高体型： 身高1.65米，身形修长纤细，体重45公斤，肩宽36厘米，腰围58厘米
脸型五官： 标准瓜子脸，脸长18厘米，最宽处12厘米。额头饱满光洁高度5厘米。细长柳叶眉长5厘米，眉色乌黑。丹凤眼双眼皮，眼长3.5厘米，眼尾微微上挑，眼珠深黑色，眼角微红似有泪痕。鼻梁高挺秀气，鼻尖圆润。樱桃小口，上下唇薄厚适中，唇色淡粉红色，嘴角微微下垂带忧郁
肤色质感： 皮肤白皙细腻，肤质光滑如玉
发型发色： 乌黑浓密长发，发质柔顺有光泽，长度60厘米。额前留短碎刘海至眉上1厘米
气质特征： 清秀脱俗，温婉清雅，带有书卷气息，神情忧郁哀伤
服装描述（全片统一）：

外层： 月白色宽袖长袍，长度至脚踝145厘米，袖长80厘米，袖口宽40厘米
袍面装饰： 绣有淡青色竹叶图案，分布在肩部、袖口位置，图案细腻清雅
内层： 淡粉色交领中衣，V领口深度20厘米
腰带： 淡粉色丝绸腰带，宽度6厘米
下身： 月白色长裙，裙长至脚面
鞋履： 绣花布鞋，淡粉色，绣有小花图案
发型： 头发梳成坠马髻，髻位于头顶偏后，高度8厘米。髻上插白玉簪1支，长度12厘米。两侧各留一缕长发垂至胸前，发长60厘米。

手持道具： 花锄一把，竹制，长度1.2米，锄头宽度15厘米。花篮一个，竹编，直径25厘米，高度20厘米，篮内盛放落花。

镜头1 - 园中拾花 [0-10秒]
开场[0-1秒]： 竹林竹竿表面充满画面，竹竿青绿色，直径8厘米，表面光滑，竹节清晰可见，竹节间距30厘米。镜头距离竹竿0.3米。

后移展开[1-2.5秒]： 镜头以每秒4米速度后退，从竹竿特写拉开。1.8秒时竹林边缘花园显露，2.5秒时场景完整，镜头停在距竹林6米处，高度1.5米。

场景： 大观园花园，春日午后。花园占地约80平方米，地面青石板铺路，石板尺寸50x50厘米。园中桃树3棵，树高4-5米，树干直径30厘米，树冠直径3米。桃花盛开，粉色花瓣，花朵直径4厘米。地面散落大量粉色桃花花瓣，花瓣长度3-4厘米，数量约500片。远处假山石高2米，灰褐色。竹林位于画面左侧，竹子高度6-8米。天空淡蓝色，白云朵朵，云层覆盖率40%。

画风： 写实主义电影风格，超高清画质，古典园林纪实美学。

色彩： 粉色、绿色、月白色、淡蓝色主调，色温5500K。色彩柔和淡雅，饱和度适中偏低，营造古典诗意氛围。

光影： 午后阳光从右上方60度角照射，色温5500K，光线柔和温暖。林黛玉面部受光柔和，皮肤白皙。地面花瓣投下淡淡阴影，长度10厘米。桃树树冠投影清晰，阴影长度2米。明暗对比2:1，柔和通透。

人物位置动作[2.5-8秒]： 林黛玉站在桃树下方，占画面35%。左手提花篮，花篮悬空距地面60厘米。右手弯腰拾起地面花瓣，身体前倾30度。2.5秒时右手捡起一片花瓣。3秒时将花瓣轻放入花篮。3.5秒时再次弯腰拾起花瓣。动作缓慢温柔，每次拾花耗时1.5秒。表情哀伤忧郁，眉头微蹙，眼角泛红。4.5秒时她直起身体，低头看向篮中花瓣，眼神悲戚。5.5秒时她缓慢向前走3步，每步约40厘米，月白色长袍下摆随步伐轻摆，摆幅10-15厘米。7秒时她停下，再次弯腰拾花。

镜头运动[8-9秒]： 镜头平稳向右平移，1秒内移动2米。画面右侧假山石逐渐进入画面，假山石高2米，宽1.5米，灰褐色，表面粗糙，石纹清晰。

结尾过渡[9-10秒]： 镜头以每秒6米速度向假山石推进，从2米推至0.3米。假山石充满画面80%-100%。10秒时画面完全被灰褐色假山石表面填满，石纹和苔藓清晰可见。

镜头2 - 含泪葬花 [10-20秒]
开场[10-11秒]： 灰褐色假山石表面充满画面，石纹粗糙，石缝中长有绿色苔藓，苔藓覆盖率30%。镜头距假山石0.3米。

后移展开[11-12.5秒]： 镜头以每秒5米速度后退，从假山石特写拉开。11.8秒时假山石后方花冢显露，12.5秒时场景完整，镜头停在距假山石7米处，高度1.4米。

场景： 大观园僻静角落，花冢所在地。地面泥土松软，深褐色。花冢高度50厘米，直径1米，土堆呈圆形隆起。花冢前方有小型石碑，石碑高30厘米，宽20厘米，灰白色，碑上刻字模糊。花冢周围种有芍药花5株，芍药花高60厘米，开粉色白色花朵，花朵直径8厘米。远处柳树3棵，树高8米，柳枝下垂长度2米，柳叶嫩绿色，在微风中轻摆。天空云层增多，覆盖率60%，光线略暗。

画风： 写实主义电影风格，超高清画质，古典园林纪实美学，真实自然光影。

色彩： 深褐色、月白色、粉色、绿色、灰白色主调，色温5000K。色彩饱和度降低20%，营造哀伤氛围。

光影： 午后阳光被云层遮挡，光线昏暗柔和，从左上方50度角漫射，色温5000K。林黛玉面部受光不均，左侧明亮，右侧略暗。花冢投影模糊，边缘柔和。柳树阴影覆盖地面，阴影长度4米。明暗对比1.5:1，昏暗压抑。

人物位置动作[12.5-18秒]： 林黛玉跪在花冢前方，占画面40%。双膝跪地,身体直立。左手放在腿上，右手持花锄，花锄斜靠在花冢旁。花篮放在身旁地上，篮内盛满粉色花瓣。12.5秒时她右手从花篮中取出一把花瓣，约20片。13秒时她右手缓慢将花瓣撒在花冢上，手臂抬起高度60厘米，花瓣从手中飘落，飘落时间1.5秒，花瓣在空中旋转，旋转速度每秒120度。14.5秒时花瓣落在花冢上。15秒时她再次取花瓣。16秒时再次撒花。表情悲伤，眼角有泪痕，泪珠直径2毫米，顺脸颊流下，流动速度每秒1厘米。嘴唇微微颤抖。17秒时她低头，头部下垂30度，双肩微微颤动，似在抽泣。月白色长袍袖口垂地，袖口摆放地面。

镜头运动[18-19秒]： 镜头缓慢向右平移，1秒内移动2米。画面右侧柳树树干进入画面，柳树树干直径40厘米，高度8米，深褐色树皮，树皮纹理垂直。

结尾过渡[19-20秒]： 镜头以每秒7米速度向柳树树干推进，从2米推至0.3米。柳树树干充满画面80%-100%。20秒时画面完全被深褐色柳树树皮纹理填满，树皮裂纹清晰可见，裂纹深度0.8-1.2厘米。

镜头3 - 怆然离去 [20-30秒]
开场[20-21秒]： 深褐色柳树树皮纹理充满画面，树皮纹理垂直走向，裂纹深0.8-1.2厘米，表面粗糙。镜头距树干0.3米。

后移展开[21-22.5秒]： 镜头以每秒5米速度后退，从树干特写拉开。21.8秒时柳树下方小径显露，22.5秒时场景完整，镜头停在距树干7米处，高度1.5米。

场景： 大观园林间小径，通往住所方向。小径宽度1.5米，青石板铺设，石板尺寸40x40厘米。小径两旁种有柳树，柳树间距5米，柳枝垂下覆盖小径，形成绿色拱廊。地面散落少量花瓣。远处可见中式古典建筑，飞檐翘角，建筑距离30米，灰色砖瓦，红色门窗。天空云层厚重，覆盖率80%，天色暗沉。

画风： 写实主义电影风格，超高清画质，古典园林纪实美学，真实自然光影。

色彩： 绿色、月白色、灰色、深褐色主调，色温4800K。色彩饱和度降低25%，营造离别哀伤氛围。

光影： 午后光线昏暗，天空仿佛即将下雨，从左侧40度角漫射，色温4800K。林黛玉面部受光微弱，整体处于柳树阴影中。柳树树冠投下大面积阴影，覆盖小径80%区域。远处建筑轮廓模糊，光影效果自然。明暗对比1.2:1，昏暗压抑。

人物位置动作[22.5-28秒]： 林黛玉站在小径中央，占画面30%。左手提空花篮，花篮悬空距地面50厘米。右手持花锄，花锄斜靠在右肩，锄头向后。表情哀伤疲惫，眼神空洞，眼角泪痕未干。22.5秒时她缓慢向前走，步伐沉重缓慢，每步约30厘米，每步耗时1.5秒。月白色长袍下摆随步伐轻摆，摆幅5-8厘米。袖口随手臂动作飘动，飘动幅度15厘米。24秒时她走过3步，行进90厘米。25秒时她微微侧头，看向身后方向，头部转动30度，眼神留恋。26秒时她转回头，继续前行。27秒时她的身影逐渐远去，身形变小，占画面20%。28秒时她走到小径尽头，背影模糊。

镜头运动[28-29秒]： 镜头保持静止，林黛玉身影渐行渐远。28.5秒时画面右侧柳枝垂下，柳枝长度2米，柳叶密集，逐渐进入画面遮挡视线。

结尾过渡[29-30秒]： 柳枝在微风中摆动，逐渐充满画面80%-100%。30秒时画面完全被嫩绿色柳叶填满，柳叶长度5-8厘米，叶片细长，叶脉清晰可见。柳叶随风轻摆，摆幅3-5厘米，画面转为绿色柳叶特写。

全局画面特效： 电影色彩分级，古典诗意色调，写实主义风格。三镜头采用自然景物遮挡转场。镜头1色彩柔和淡雅，饱和度适中，营造春日园林氛围。镜头2饱和度降低20%，光线昏暗，营造哀伤氛围。镜头3饱和度降低25%，光线更加昏暗，营造离别忧郁氛围。3%颗粒质感贯穿全程，模拟古典胶片质感。景深效果自然，光圈F2.0-F2.8，虚化背景，突出主体人物。画面整体呈现真实细腻的古典诗意影像。




"""
user_requirement = "真实电影风格，不要超过10句对话，面向短剧用户,一定要保持人物一致性,一定要保持人物一致性"

style = "真实电影风格"

working_dir = r".working_dir/黛玉葬花"

chat_model = init_chat_model(
    model="claude-sonnet-4-5-20250929",  # claude-sonnet-4-5-20250929
    api_key="sk-RsgJVQohu9e1HBMgdYsy9mQFKs3ue4fZXL2iGMjiiupiViQB",
    base_url=r"https://yunwu.ai/v1",
    model_provider="openai",
)


# image_generator = GeminiImageGenerator(
#     api_key="sk-RsgJVQohu9e1HBMgdYsy9mQFKs3ue4fZXL2iGMjiiupiViQB",
#     base_url="https://yunwu.ai",
#     api_version="v1beta",
#     model="gemini-2.5-flash-image-preview",
# )

image_generator = DoubaoSeedreamImageGenerator(
    api_key="sk-RsgJVQohu9e1HBMgdYsy9mQFKs3ue4fZXL2iGMjiiupiViQB",
)

# video_generator = VeoVideoGenerator(
#     api_key="sk-RsgJVQohu9e1HBMgdYsy9mQFKs3ue4fZXL2iGMjiiupiViQB",
# )

video_generator = DoubaoSeedanceVideoGenerator(
    api_key="sk-RsgJVQohu9e1HBMgdYsy9mQFKs3ue4fZXL2iGMjiiupiViQB",
)

pipeline = Script2VideoPipeline(
    chat_model=chat_model,
    image_generator=image_generator,
    video_generator=video_generator,
    working_dir=working_dir,
)

asyncio.run(
    pipeline(
        script=script,
        user_requirement=user_requirement,
        style=style,
    )
)




